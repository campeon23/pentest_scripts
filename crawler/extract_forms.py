#!/usr/bin/env python
import argparse
import requests
import urllib.parse as urlparse
from bs4 import BeautifulSoup


'''
        Run the script by providing the target_url argument in the following format: 
        
        python extract_forms.py --target_url http://192.168.100.32/mutillidae/index.php?page=dns-lookup.php.
'''


def send_request(url):
    """
    Function to send a GET request to the provided URL.
    """
    try:
        return requests.get(url)
    except requests.exceptions.ConnectionError:
        pass


def get_form_details(target_url):
    """
    Function to parse forms from the HTML content of the provided URL.
    It then constructs the post_data and sends a POST request for each form.
    """
    response = send_request(target_url)
    parsed_html = BeautifulSoup(response.content, features='lxml')

    # Finding all forms in the HTML content
    forms_list = parsed_html.findAll('form')

    for form in forms_list:
        action = form.get('action')
        # Constructing the absolute URL
        post_url = urlparse.urljoin(target_url, action)
        method = form.get('method')

        input_list = form.findAll('input')
        post_data = {}
        for inp in input_list:
            input_name = inp.get('name')
            input_type = inp.get('type')
            input_value = inp.get('value')
            if input_type == 'text':
                input_value = 'test'

            post_data[input_name] = input_value

        # Sending a POST request with the constructed data
        result = requests.post(post_url, data=post_data)
        print(BeautifulSoup(result.content, features='lxml'))


def main(target_url):
    """
    The main function that runs the program.
    """
    get_form_details(target_url)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='HTML Form Details Getter')
    parser.add_argument("-t", "--target-url", dest="target_url", type=str,
                        required=True, help="The target URL")

    args = parser.parse_args()

    main(args.target_url)
