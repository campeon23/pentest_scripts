#!/usr/bin/env python

import subprocess
import smtplib
import re
import argparse
import hvac
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from Crypto.Cipher import AES
from Crypto.Util.Padding import unpad

'''
        This script can be executed using the command line:

        python script.py -c "sc query type= service state= all" -s "WiFi router config" -smtp "smtp-relay.gmail.com" -p 587

        If you want to use a password from an encrypted file:

        python script.py -c "sc query type= service state= all" -s "WiFi router config" -smtp "smtp-relay.gmail.com" -p 587 -f "encrypted_password.txt" -k "my_encryption_key"
'''


def get_password_from_vault(vault_addr, vault_token, secret_path, secret_key):
    """
    Fetch a secret from HashiCorp Vault.

    Parameters:
    vault_addr (str): The URL of the HashiCorp Vault instance.
    vault_token (str): A valid Vault token.
    secret_path (str): The path of the secret in the Vault.
    secret_key (str): The key of the secret to fetch.

    Returns:
    secret (str): The requested secret.
    """

    client = hvac.Client(url=vault_addr, token=vault_token)

    if not client.is_authenticated():
        print("Error: Invalid Vault token.")
        return None

    read_response = client.secrets.kv.v2.read_secret_version(path=secret_path)

    if secret_key in read_response["data"]["data"]:
        return read_response["data"]["data"][secret_key]
    else:
        print(f"Error: {secret_key} not found in the secret.")
        return None


def get_password_from_encrypted_file(file_path, key):
    """
    Fetch a password from an encrypted file.

    Parameters:
    file_path (str): The path to the encrypted file.
    key (bytes): The decryption key. It should be 16, 24 or 32 bytes long.

    Returns:
    password (str): The decrypted password.
    """

    cipher = AES.new(key, AES.MODE_ECB)

    with open(file_path, 'rb') as f:
        ciphertext = f.read()

    plaintext = unpad(cipher.decrypt(ciphertext), AES.block_size)

    return plaintext.decode('utf-8')


def send_mail(email, password, message, smtp_server, smtp_port):
    msg = MIMEMultipart()
    msg['From'] = email
    msg['To'] = email
    msg['Subject'] = 'WiFi router config'
    msg.attach(MIMEText(message, _subtype='plain', _charset='UTF-8'))

    server = smtplib.SMTP(smtp_server, smtp_port)
    server.starttls()
    server.login(email, password)
    server.sendmail(email, email, msg.as_string())
    server.quit()


def main(email, command, subject, smtp_server, smtp_port, vault_path=None, pass_file=None, key=None):
    result = subprocess.run(command, shell=True,
                            stdout=subprocess.PIPE).stdout.decode('us-ascii')
    services = re.findall('(?:SERVICE_NAME:* )(.*)', result)

    for service in services:
        service = service.replace('\r', '')
        command = 'sc query ' + service
        current_result = subprocess.check_output(
            command, shell=True).decode('us-ascii')
        service_status = re.search('(?:STATE\s*: \d\s)(.*)', current_result)
        result = result + service + ': ' + service_status.group(1) + '\r\n'

    if vault_path:
        password = get_password_from_vault(vault_path)
    elif pass_file and key:
        password = get_password_from_encrypted_file(pass_file, key)
    else:
        raise Exception(
            "Either vault_path or (pass_file and key) should be provided")

    send_mail(email, password, result, smtp_server, smtp_port)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description='Service status monitoring script.')
    parser.add_argument('-e', '--email', type=str,
                        help='Email address', required=True)
    parser.add_argument('-c', '--command', type=str,
                        help='Command to run', required=True)
    parser.add_argument('-s', '--subject', type=str,
                        help='Email subject', required=True)
    parser.add_argument('-S', '--smtp-server', type=str,
                        help='SMTP server', required=True)
    parser.add_argument('-P', '--smtp-port', type=int,
                        help='SMTP port', required=True)
    parser.add_argument('-v', '--vault-path', type=str,
                        help='Path to the vault secret')
    parser.add_argument('-f', '--pass-file', type=str,
                        help='Path to the encrypted password file')
    parser.add_argument('-k', '--key', type=str, help='Encryption key')

    args = parser.parse_args()

    main(args.email, args.command, args.subject, args.smtp_server,
         args.smtp_port, args.vault_path, args.pass_file, args.key)
